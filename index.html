<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>BMU Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input[type="text"], select { padding:6px 10px; border:1px solid #ddd; border-radius:8px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
    button:hover { background:#f7f7f7; }
    .tabs { display:flex; gap:8px; margin:12px 0; }
    .tab-btn { border:1px solid #ccc; background:#f6f6f6; padding:6px 10px; border-radius:999px; }
    .tab-btn.active { background:#111; color:#fff; border-color:#111; }
    .panel { display:none; }
    .panel.active { display:block; }
    table { border-collapse:collapse; width:100%; margin-top:8px; }
    th, td { border:1px solid #e5e5e5; padding:8px; text-align:left; }
    th { background:#fafafa; }
    .pill { padding:2px 8px; border-radius:10px; font-size:12px; }
    .pill-available   { background:#e8f7e8; border:1px solid #a6d9a6; color:#0e6026; }
    .pill-reserved    { background:#fff7e6; border:1px solid #f6d28a; color:#8a4b00; }
    .pill-unavailable { background:#ffe0e0; border:1px solid #ef9a9a; color:#9b111e; }
    .muted { color:#666; font-size:12px; }
    .warn { color:#9b111e; font-size:12px; }
  </style>
</head>
<body>
  <h1>BMU Dashboard</h1>

  <div class="row">
    <label for="nurse">Nurse (name or email):</label>
    <input id="nurse" type="text" placeholder="e.g. may@example.com" />
    <button id="saveNurse">Save</button>
    <span class="muted" id="nurseSavedNote"></span>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="overall">Overall</button>
    <button class="tab-btn" data-tab="myreserved">My Reserved</button>
  </div>

  <div id="overall" class="panel active">
    <div class="row">
      <label>Status:
        <select id="statusFilter">
          <option value="">All</option>
          <option value="Available">Available</option>
          <option value="Reserved">Reserved</option>
          <option value="Unavailable">Unavailable</option>
        </select>
      </label>
      <label>Area:
        <input id="areaFilter" type="text" placeholder="Type area to filter…" />
      </label>
      <button id="refreshBtn">Refresh</button>
      <span id="sourceNote" class="muted"></span>
    </div>
    <div id="tblOverall"></div>
  </div>

  <div id="myreserved" class="panel">
    <div class="row"><span class="muted">Showing beds reserved or unavailable by you.</span></div>
    <div id="tblMyReserved"></div>
  </div>

<script>
  // Your links
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwv8TQaOmfgQ_vbiYrSChg922BXKWn3KghG69oNBL_wIr9y1ZqSUaWyTUZbfLWrXAub9w/exec";
  const PUBHTML_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqIG5jdlPsNsD8r-IP3XccHrLkszIxFVSMsGBornwBZ8kjK75aVncpCMew4YkD846KtMflV39-Aoff/pubhtml?gid=0&single=true";

  // Nurse identity
  const nurseInput = document.getElementById('nurse');
  const nurseNote  = document.getElementById('nurseSavedNote');
  document.getElementById('saveNurse').onclick = () => {
    const v = nurseInput.value.trim();
    if (!v) return;
    localStorage.setItem('bmu_nurse', v);
    nurseNote.textContent = `Saved as ${v}`;
    render();
  };
  const saved = localStorage.getItem('bmu_nurse') || "";
  if (saved) { nurseInput.value = saved; nurseNote.textContent = `Saved as ${saved}`; }

  // Tabs
  const tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  }));

  // Filters
  const statusFilter = document.getElementById('statusFilter');
  const areaFilter   = document.getElementById('areaFilter');
  const sourceNote   = document.getElementById('sourceNote');
  document.getElementById('refreshBtn').onclick = () => loadBeds();
  statusFilter.onchange = () => render();
  areaFilter.oninput    = () => render();

  // Data
  let beds = []; // {bedID, area, status, nurse, timeBooked, lastUpdated}

  // Loader: try Apps Script JSON first; if empty/error, fall back to pubhtml
  async function loadBeds(){
    try {
      const api = await fetch(`${WEB_APP_URL}?fn=beds&_=${Date.now()}`, { cache: 'no-store' });
      const j = await api.json();
      if (j && j.ok && Array.isArray(j.beds) && j.beds.length) {
        beds = j.beds;
        sourceNote.textContent = "source: Apps Script (live JSON)";
        render();
        return;
      }
    } catch(e) {
      // ignore, we'll fall back
    }
    // Fallback to pubhtml (parse the rendered table)
    try {
      const res = await fetch(`${PUBHTML_URL}&_=${Date.now()}`, { cache: 'no-store' });
      const html = await res.text();
      beds = parsePubHtml(html);
      sourceNote.textContent = "source: Published sheet (HTML)";
      render();
    } catch(err) {
      sourceNote.textContent = "couldn’t load data";
      beds = [];
      render();
    }
  }

  // Parse Google Sheets pubhtml (looks like a big <table class="waffle">)
  function parsePubHtml(html) {
    const dom = new DOMParser().parseFromString(html, "text/html");
    // find first sheet table
    const table = dom.querySelector("table.waffle");
    if (!table) return [];
    const rows = Array.from(table.querySelectorAll("tr"));
    if (rows.length < 2) return [];

    // header
    const headers = Array.from(rows[0].querySelectorAll("th, td")).map(c => c.textContent.trim());
    const idx = {
      bedID: headers.findIndex(h => /bed id/i.test(h)),
      area: headers.findIndex(h => /^area$/i.test(h)),
      status: headers.findIndex(h => /^status$/i.test(h)),
      nurse: headers.findIndex(h => /^nurse$/i.test(h)),
      timeBooked: headers.findIndex(h => /time\s*booked/i.test(h)),
      lastUpdated: headers.findIndex(h => /last\s*updated/i.test(h))
    };

    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const cells = Array.from(rows[r].querySelectorAll("td")).map(c => c.textContent.trim());
      if (!cells.length) continue;

      const bedID = safeCell(cells, idx.bedID);
      if (!bedID) continue;

      out.push({
        bedID,
        area:        safeCell(cells, idx.area),
        status:      safeCell(cells, idx.status),
        nurse:       safeCell(cells, idx.nurse),
        timeBooked:  safeCell(cells, idx.timeBooked),
        lastUpdated: safeCell(cells, idx.lastUpdated)
      });
    }
    return out;
  }
  function safeCell(arr, i){ return (i >= 0 && i < arr.length) ? arr[i] : ""; }

  // Render helpers
  function pill(status){
    const s = (status||"").toLowerCase();
    if (s==="available")   return `<span class="pill pill-available">Available</span>`;
    if (s==="reserved")    return `<span class="pill pill-reserved">Reserved</span>`;
    if (s==="unavailable" || s==="booked") return `<span class="pill pill-unavailable">Unavailable</span>`;
    return status || "";
  }

  function actionsForRow(row){
    const s = (row.status||"").toLowerCase();
    if (s==="available") {
      return `<button onclick="reserveBed('${escapeAttr(row.bedID)}', '${escapeAttr(row.area)}')">Reserve 30m</button>`;
    }
    return `<button onclick="markAvailable('${escapeAttr(row.bedID)}', '${escapeAttr(row.area)}')">Mark Available</button>`;
  }

  function mountTable(targetId, rows){
    const el = document.getElementById(targetId);
    if (!rows.length) {
      el.innerHTML = "<div class='muted'>No rows (check Beds sheet headers and Bed IDs)</div>";
      return;
    }
    const html = [
      "<table>",
      "<thead><tr><th>Bed ID</th><th>Area</th><th>Status</th><th>Nurse</th><th>Time</th><th style='width:1%'>Action</th></tr></thead>",
      "<tbody>",
      ...rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.bedID)}</td>
          <td>${escapeHtml(r.area)}</td>
          <td>${pill(r.status)}</td>
          <td>${escapeHtml(r.nurse)}</td>
          <td>${escapeHtml(r.timeBooked)}</td>
          <td style="white-space:nowrap">${actionsForRow(r)}</td>
        </tr>
      `),
      "</tbody></table>"
    ].join("");
    el.innerHTML = html;
  }

  function render(){
    const areaQ = (areaFilter.value||"").toLowerCase();
    const statusQ = statusFilter.value; // "", "Available", "Reserved", "Unavailable"
    const me = (localStorage.getItem('bmu_nurse')||"").trim().toLowerCase();

    const normalized = beds.map(b => ({
      ...b,
      // normalize status strings coming from either source
      status: normalizeStatusDisplay(b.status)
    }));

    const filtered = normalized.filter(b =>
      (areaQ==="" || (b.area||"").toLowerCase().includes(areaQ)) &&
      (statusQ==="" || (b.status||"") === statusQ)
    );
    mountTable("tblOverall", filtered);

    const mine = normalized.filter(b => {
      const nurse = (b.nurse||"").toLowerCase();
      const s = (b.status||"").toLowerCase();
      return me && nurse===me && (s==="reserved" || s==="unavailable");
    });
    mountTable("tblMyReserved", mine);
  }

  function normalizeStatusDisplay(s) {
    s = (s||"").toString().trim();
    const low = s.toLowerCase();
    if (low === "booked") return "Unavailable";
    if (low === "unavailable") return "Unavailable";
    if (low === "reserved") return "Reserved";
    if (low === "available") return "Available";
    // if your sheet sometimes has lowercase words, title-case them
    if (low === "avail") return "Available";
    return s;
  }

  // POST helpers (write through Apps Script only)
  async function callApi(payload){
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" }, // avoids preflight with Apps Script
      body: JSON.stringify(payload)
    });
    return res.json();
  }
  window.reserveBed = async (bedID, area) => {
    const nurse = (localStorage.getItem('bmu_nurse')||"").trim();
    if (!nurse) { alert("Enter your nurse name/email and click Save."); return; }
    await callApi({ bedID, area, status: "reserved", nurseName: nurse, clientTime: new Date().toISOString() });
    await loadBeds();
  };
  window.markAvailable = async (bedID, area) => {
    const nurse = (localStorage.getItem('bmu_nurse')||"").trim(); // optional
    await callApi({ bedID, area, status: "available", nurseName: nurse, clientTime: new Date().toISOString() });
    await loadBeds();
  };

  // small escapes
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

  // Go
  loadBeds();
  setInterval(loadBeds, 15000);
</script>
</body>
</html>
