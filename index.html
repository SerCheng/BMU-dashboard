<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>BMU Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input[type="text"], select { padding:6px 10px; border:1px solid #ddd; border-radius:8px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
    button:hover { background:#f7f7f7; }
    table { border-collapse:collapse; width:100%; margin-top:8px; }
    th, td { border:1px solid #e5e5e5; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; }
    .pill { padding:2px 8px; border-radius:10px; font-size:12px; }
    .pill-available   { background:#e8f7e8; border:1px solid #a6d9a6; color:#0e6026; }
    .pill-reserved    { background:#fff7e6; border:1px solid #f6d28a; color:#8a4b00; }
    .pill-unavailable { background:#ffe9e9; border:1px solid #f5bcbc; color:#9b111e; }
    .muted { color:#666; font-size:12px; }
    .badge { font-size:12px; padding:4px 8px; border:1px solid #ddd; border-radius:999px; }
  </style>
</head>
<body>
  <h1>BMU Dashboard</h1>

  <div class="row">
    <label for="nurse">Nurse (name or email):</label>
    <input id="nurse" type="text" placeholder="e.g. may@example.com" />
    <button id="saveNurse">Save</button>
    <span class="muted" id="nurseSavedNote"></span>
    <span id="diag" class="badge muted"></span>
  </div>

  <div class="row">
    <label>Status:
      <select id="statusFilter">
        <option value="">All</option>
        <option value="Available">Available</option>
        <option value="Reserved">Reserved</option>
        <option value="Unavailable">Unavailable</option>
      </select>
    </label>
    <label>Area:
      <input id="areaFilter" type="text" placeholder="Type area to filter…" />
    </label>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="tbl"></div>

<script>
  // ===== config =====
  // Live JSON from your Apps Script web app:
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwoy4Y4Lb2XqS_K7AtU0vyUxdjB5xK8W4qpl__Ca13QU3bAhMiMDsal7fDXBfe4-OLpUA/exec";
  // CSV fallback (same spreadsheet published as CSV):
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqIG5jdlPsNsD8r-IP3XccHrLkszIxFVSMsGBornwBZ8kjK75aVncpCMew4YkD846KtMflV39-Aoff/pub?gid=0&single=true&output=csv";

  // ===== ui refs =====
  const nurseInput = document.getElementById('nurse');
  const nurseNote  = document.getElementById('nurseSavedNote');
  const diag       = document.getElementById('diag');
  const statusFilter = document.getElementById('statusFilter');
  const areaFilter   = document.getElementById('areaFilter');

  document.getElementById('saveNurse').onclick = () => {
    const v = nurseInput.value.trim();
    if (!v) return;
    localStorage.setItem('bmu_nurse', v);
    nurseNote.textContent = `Saved as ${v}`;
    render();
  };
  const saved = localStorage.getItem('bmu_nurse') || "";
  if (saved) { nurseInput.value = saved; nurseNote.textContent = `Saved as ${saved}`; }

  document.getElementById('refreshBtn').onclick = () => loadBeds();
  statusFilter.onchange = () => render();
  areaFilter.oninput    = () => render();

  // ===== state =====
  let beds = [];                 // array of rows
  let reserveMinutes = 30;       // if backend returns this, we’ll use it

  // ===== helpers =====
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  async function fetchJsonWithRetry(url, opts={}, tries=3, delayMs=600){
    let lastErr;
    for (let i=0; i<tries; i++){
      try{
        const res = await fetch(url, { cache:'no-store', ...opts });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        return JSON.parse(text);
      }catch(e){
        lastErr = e;
        await sleep(delayMs);
      }
    }
    throw lastErr || new Error('fetch failed');
  }

  function splitCsvRow(row) {
    const out = []; let cur = '', inQ = false;
    for (let i = 0; i < row.length; i++) {
      const c = row[i];
      if (c === '"') { if (inQ && row[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
      else if (c === ',' && !inQ) { out.push(cur); cur = ''; }
      else cur += c;
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  function pill(status){
    const s = (status||"").toLowerCase();
    if (s==="available")   return `<span class="pill pill-available">Available</span>`;
    if (s==="reserved")    return `<span class="pill pill-reserved">Reserved</span>`;
    if (s==="unavailable" || s==="booked") return `<span class="pill pill-unavailable">Unavailable</span>`;
    return status || "";
  }

  function fmtTime(iso){
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
  }

  // ===== load =====
  async function loadBeds(){
    // try API with retry
    try {
      const json = await fetchJsonWithRetry(`${WEB_APP_URL}?fn=beds&_=${Date.now()}`, {}, 3, 600);
      if (!json || !json.ok || !Array.isArray(json.beds)) throw new Error("Bad JSON");
      beds = json.beds;
      reserveMinutes = json.reserveMinutes || 30;
      diag.textContent = `API ok (${beds.length} rows)`;
      render();
      return;
    } catch (e) {
      console.warn("API load failed, falling back to CSV:", e);
      diag.textContent = `API failed: ${e.message || e} — trying CSV`;
    }

    // CSV fallback so the table never disappears
    try {
      const res = await fetch(`${CSV_URL}${CSV_URL.includes('?') ? '&' : '?'}_=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const rows = text.replace(/\r/g,'').split("\n").filter(Boolean).map(splitCsvRow);
      if (rows.length < 2) { beds = []; diag.textContent = "CSV ok (0 rows)"; render(); return; }
      const header = rows[0];
      const idx = {
        bedID: header.indexOf("Bed ID"),
        area: header.indexOf("Area"),
        status: header.indexOf("Status"),
        nurse: header.indexOf("Nurse"),
        timeBooked: header.indexOf("Time Booked"),
        lastUpdated: header.indexOf("Last Updated")
      };
      beds = rows.slice(1).map(r => ({
        bedID: r[idx.bedID] || "",
        area: r[idx.area] || "",
        status: r[idx.status] || "",
        nurse: r[idx.nurse] || "",
        timeBooked: r[idx.timeBooked] || "",
        lastUpdated: r[idx.lastUpdated] || ""
      }));
      diag.textContent = `CSV ok (${beds.length} rows)`;
      render();
    } catch (e) {
      console.error("CSV load error:", e);
      diag.textContent = `CSV error: ${e.message || e}`;
      beds = [];
      render();
    }
  }

  // ===== render =====
  function actionsForRow(row){
    // Only show Reserve when Available; otherwise blank
    const s = (row.status||"").toLowerCase();
    if (s === "available") {
      return `<button onclick="reserveBed('${escapeAttr(row.bedID)}', '${escapeAttr(row.area||"")}')">Reserve 30m</button>`;
    }
    return "";
  }

  function mountTable(rows){
    const el = document.getElementById('tbl');
    if (!rows.length) { el.innerHTML = "<div class='muted'>No rows</div>"; return; }
    const html = [
      "<table>",
      "<thead><tr><th>Bed ID</th><th>Area</th><th>Status</th><th>Nurse</th><th>Time</th><th style='width:1%'>Action</th></tr></thead>",
      "<tbody>",
      ...rows.map(r=>`
        <tr>
          <td>${escapeHtml(String(r.bedID))}</td>
          <td>${escapeHtml(r.area||"")}</td>
          <td>${pill(r.status||"")}</td>
          <td>${escapeHtml(r.nurse||"")}</td>
          <td>${fmtTime(r.timeBooked||"")}</td>
          <td style="white-space:nowrap">${actionsForRow(r)}</td>
        </tr>
      `),
      "</tbody></table>"
    ].join("");
    el.innerHTML = html;
  }

  function render(){
    const areaQ = (areaFilter.value||"").toLowerCase();
    const statusQ = (statusFilter.value||"").toLowerCase();
    const filtered = beds.filter(b =>
      (areaQ==="" || String(b.area||"").toLowerCase().includes(areaQ)) &&
      (statusQ==="" || String(b.status||"").toLowerCase() === statusQ)
    );
    mountTable(filtered);
  }

  // ===== writes =====
  async function callApi(payload){
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" }, // keep this to avoid preflight
      body: JSON.stringify(payload)
    });
    // be defensive; Apps Script sometimes returns non-JSON on errors
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = { ok:false, raw:text }; }
    return { status: res.status, json };
  }

  function optimisticUpdate(bedID, patch) {
    const idx = beds.findIndex(b => String(b.bedID) === String(bedID));
    if (idx >= 0) { beds[idx] = { ...beds[idx], ...patch }; render(); }
  }

  window.reserveBed = async (bedID, area) => {
    const nurse = (localStorage.getItem('bmu_nurse')||"").trim();
    if (!nurse) { alert("Enter your Nurse name/email and click Save first."); return; }
    const nowIso = new Date().toISOString();

    // optimistic UI so the name “sticks” right away
    optimisticUpdate(bedID, { status: "Reserved", nurse, timeBooked: nowIso });

    // call backend; then do gentle refresh with retries and CSV fallback inside loadBeds()
    try {
      await callApi({ bedID, area, status: "reserved", nurseName: nurse, clientTime: nowIso });
    } finally {
      await sleep(500);
      try { await loadBeds(); } catch {}
      await sleep(500);
      try { await loadBeds(); } catch {}
    }
  };

  // init
  loadBeds();
</script>
</body>
</html>
